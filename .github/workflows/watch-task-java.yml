name: Watch Slayer Task.java

on:
  schedule:
    - cron: "0 0 * * *"   # once per day (UTC)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  watch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4

      - name: Check latest upstream commit touching Task.java
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          SHA=$(curl -sS \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/runelite/runelite/commits?path=runelite-client/src/main/java/net/runelite/client/plugins/slayer/Task.java&per_page=1" \
            | jq -r '.[0].sha')

          echo "Latest SHA: $SHA"

          if [ -f last_sha.txt ]; then
            OLD_SHA=$(cat last_sha.txt)
          else
            OLD_SHA=""
          fi

          if [ "$SHA" != "$OLD_SHA" ]; then
            echo "CHANGE DETECTED"

            echo "$SHA" > last_sha.txt

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add last_sha.txt
            git commit -m "chore: update last seen Task.java sha"
            git push

            # fail intentionally so GitHub notifies you
            exit 1
          fi

          echo "No change"
